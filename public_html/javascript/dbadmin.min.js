/**
 * glFusion DB Admin - Conversion / Optimization Ajax Driver
 *
 * Iterates over tables to convert / optimized based on mode
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2016 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},e=null,n=null,a=null,o=0,r=0,i=null;t.update=function(){return o=0,a=$("#dbcvtform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#dbconvertbutton").prop("disabled",!0),$("#dbconvertbutton").html(lang_converting),c(),$.ajax({type:"POST",dataType:"json",url:a,data:{mode:"dblist",engine:engine},timeout:3e4}).done(function(t){var a=$.parseJSON(t.json);e=a.tablelist,r=e.length,n=e.shift(),d(lang_converting),window.setTimeout(l,1e3)}),!1},t.init=function(){"EdCICTd8idbqXnyfQ02FsQqD"==gl&&(i=$("#batchinterface_msg"),$t=$("#t"),i&&$("#dbconvertbutton").click(t.update))};var l=function(){n?$.ajax({type:"POST",dataType:"json",url:a,data:{mode:mode,table:n,engine:engine},timeout:6e4}).done(function(t){var a=$.parseJSON(t.json);0!=a.errorCode&&console.log("DBadmin: The table conversion did not complete"),d(lang_converting+" "+o+"/"+r+" - "+n);var i=Math.round(o/r*100);$("#progress-bar").css("width",i+"%"),$("#progress-bar").html(i+"%"),n=e.shift(),o++}).fail(function(t,e){console.log("timeout"===e?"DBadmin: Timeout converting table "+n:"DBadmin: Error converting table "+n),alert("dbAdmin: Error converting table "+n),window.location.href="database.php"}).always(function(){var t=250;window.setTimeout(l,t)}):s()},s=function(){$("#progress-bar").css("width","100%"),$("#progress-bar").html("100%"),u(),d(lang_success),window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:a,data:{mode:mode+"complete",engine:engine}}).done(function(){$("#dbconvertbutton").prop("disabled",!1),$("#dbconvertbutton").html(lang_convert),UIkit.modal.confirm(lang_success,function(){$(location).attr("href","database.php")},function(){},{labels:{Ok:lang_ok,Cancel:lang_cancel}})})},3e3)},d=function(t){i.html(t)},c=function(){$t.show()},u=function(){$t.hide()};return t}();$(function(){dbadminint.init()});