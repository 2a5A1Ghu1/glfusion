/**
 * glFusion DB Admin - Conversion / Optimization Ajax Driver
 *
 * Iterates over tables to convert / optimized based on mode
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2017 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},n=null,e=null,o=null,a=0,i=0,r=lang_error,s=0,d=null;t.update=function(){return a=0,o=$("#dbcvtform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#dbconvertbutton").prop("disabled",!0),$("#dbconvertbutton").html(lang_converting),b(),$.ajax({type:"POST",dataType:"json",url:o,data:{mode:"dblist",engine:engine},timeout:3e4}).done(function(t){var o=$.parseJSON(t.js);n=o.tablelist,i=n.length,e=n.shift(),l(lang_converting),window.setTimeout(u,1e3)}),!1},t.init=function(){"log"==gl&&(d=$("#batchinterface_msg"),$t=$("#t"),d&&$("#dbconvertbutton").click(t.update))};var u=function(){e?$.ajax({type:"POST",dataType:"json",url:o,data:{mode:mode,table:e,engine:engine},timeout:timeout}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(r=r+"ERROR: "+n.statusMessage+"<br>",s++)}).fail(function(){r=r+"ERROR: Timeout processing table "+e+"<br>",s++}).always(function(){e=n.shift(),a++,l(lang_converting+" "+a+"/"+i+" - "+e);var t=Math.round(a/i*100);$("#progress-bar").css("width",t+"%"),$("#progress-bar").html(t+"%");var o=250;window.setTimeout(u,o)}):c()},c=function(){$("#progress-bar").css("width","100%"),$("#progress-bar").html("100%"),g(),l(lang_success),window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:o,data:{mode:mode+"complete",engine:engine}}).done(function(){$("#dbconvertbutton").prop("disabled",!1),$("#dbconvertbutton").html(lang_convert),0!=s&&(lang_success=r);var t=UIkit.modal.alert(lang_success);t.on({"hide.uk.modal":function(){$(location).attr("href","database.php")}})})},3e3)},l=function(t){d.html(t)},b=function(){$t.show()},g=function(){$t.hide()};return t}();$(function(){dbadminint.init()});