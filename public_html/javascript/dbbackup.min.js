/**
 * glFusion DB Admin - Backup Ajax Driver
 *
 * Back up all tables in database
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2016 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},e=null,n=null,a=null,o=0,r=0,i=0,l=0,s=0,d=null,c="&nbsp;",u=0,m=null;t.update=function(){return o=0,a=$("#dbbackupform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#dbbackupbutton").prop("disabled",!0),$("#dbbackupbutton").html(lang_backingup),p(),$.ajax({type:"POST",dataType:"json",url:a,data:{mode:"dbbackup_init"}}).done(function(t){var a=$.parseJSON(t.json);return e=a.tablelist,l=a.totalrows,d=a.backup_filename,r=e.length,0!=a.errorCode?(h(),g("Error"),$("#dbbackupbutton").prop("disabled",!1),$("#dbbackupbutton").html(lang_backup),alert(a.statusMessage)):(n=e.shift(),g(lang_backingup),void window.setTimeout(b,1e3))}).fail(function(){alert("Error initializing the database backup"),window.location.href="database.php"}),!1},t.init=function(){"EdCICTd8idbqXnyfQ02FsQqD"==gl&&(m=$("#batchinterface_msg"),$t=$("#t"),m&&$("#dbbackupbutton").click(t.update))};var b=function(){if(n){0==i?(c="&nbsp;",u=0):(c+="&nbsp;&bull;",u++,u>20&&(u=0,c="&bull;"));var t={mode:"dbbackup_table",table:n,backup_filename:d,start:i};data=$.param(t),g(lang_backingup+" "+o+"/"+r+" - "+n+c),$.ajax({type:"POST",dataType:"json",url:a,data:data,timeout:6e4}).done(function(t){var a=$.parseJSON(t.json),l=a.processed;3==a.errorCode&&(alert("Database Backup Failed - unable to open backup file"),window.location.href="database.php"),2==a.errorCode?(console.log("DBadmin: Table backup incomplete - making another pass"),i=a.startrecord):(n=e.shift(),o++,i=0,c="&nbsp;",u=0),s+=l;var d=Math.round(o/r*100);$("#progress-bar").css("width",d+"%"),$("#progress-bar").html(d+"%");var m=250;window.setTimeout(b,m)}).fail(function(t,e){"timeout"===e&&console.log("DBadmin: Timeout - error backing up table "+n),alert("Error performing backup - timed out on table "+n),window.location.href="database.php"})}else f()},f=function(){$("#progress-bar").css("width","100%"),$("#progress-bar").html("100%"),h(),g(lang_success),i=0,l=0,s=0,window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:a,data:{mode:"dbbackup_complete",backup_filename:d}}).done(function(){$("#dbbackupbutton").html(lang_backup),UIkit.modal.confirm(lang_success,function(){$(location).attr("href","database.php")},function(){},{labels:{Ok:lang_ok,Cancel:lang_cancel}})})},2e3)},g=function(t){m.html(t)},p=function(){$t.show()},h=function(){$t.hide()};return t}();$(function(){dbadminint.init()});