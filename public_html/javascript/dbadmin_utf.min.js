/**
 * glFusion DB Admin - Ajax UTF8 Conversion
 *
 * Converts the database, tables, and columns in each table to the
 * utf8mb4_unicode_ci character set / collation.
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2017 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},a=null,e=null,n=null,o=null,r=0,i=1,l=null,d=1,s=0,u=0,c=0,m="",f=null;$t=null,t.update=function(){return d=1,l=$("#dbcvtform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#cvtb").prop("disabled",!0),$("#cvtb").html(lang_converting),T(),_(lang_retrieve_tables),$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"gettables"},timeout:3e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(alert(lang_error_gettable),window.location.href=destination),a=n.tablelist,s=a.length,e=a.shift(),window.setTimeout(w,250)}).fail(function(){alert(lang_error_gettable),window.location.href=destination}),!1},t.init=function(){"log"==gl&&(f=$("#batchinterface_msg"),$t=$("#t"),f&&$("#cvtb").click(t.update))};var b=function(){if(0==c){_(lang_converting+" database");var t={mode:"utfdb"};data=$.param(t),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var a=$.parseJSON(t.js);0!=a.errorCode&&(alert(lang_error_db+" :: "+a.message),window.location.href=destination)}).fail(function(t,a){"timeout"===a?(alert(lang_error_db),window.location.href=destination):(alert(lang_error_db),window.location.href=destination)})}v()},w=function(){if(e){var t=Math.round((d-1)/s*100);0==t&&(t=Math.round(d/s*100/2)),$("#pb").css("width",t+"%"),$("#pb").html(t+"%"),u=0;var a=250;window.setTimeout(p,a)}else b()},g=function(){if(0==u){var t={mode:"utftb",table:e};data=$.param(t),_(lang_converting+" "+d+"/"+s+" - "+e),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var a=$.parseJSON(t.js);0!=a.errorCode&&(m=m+"Table: "+e+" :: "+a.message+"<br>")}).fail(function(t,a){"timeout"===a&&(alert(lang_error_table+" :: "+e),window.location.href=destination)})}d++,e=a.shift(),window.setTimeout(w,250)},p=function(){if(e){n=null;var t={mode:"getcolumns",table:e};data=$.param(t),i=1;var a=0;$("#pb-current").css("width",a+"%"),$("#pb-current").html(a+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var a=$.parseJSON(t.js);0!=a.errorCode&&(u++,c++,m=m+"Table: "+e+" :: "+a.message+"<br>"),n=a.columnlist,r=n.length,o=n.shift()}).fail(function(t,a){m=m+"Table: "+e+" :: Failed to retrieve column list<br>","timeout"===a&&(alert(lang_error_getcolumn+" :: "+e),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(h,t)})}},h=function(){if(o){var t={mode:"utfcm",table:e,column:o};data=$.param(t),_(lang_converting+" "+d+"/"+s+" - "+e+" - "+o);var a=Math.round(i/r*100);$("#pb-current").css("width",a+"%"),$("#pb-current").html(a+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var a=$.parseJSON(t.js);0!=a.errorCode&&(u++,c++,m=m+"Table: "+e+" Column: "+o+" :: "+a.message+"<br>"),i++}).fail(function(t,a){"timeout"===a&&(m=m+"Table: "+e+" Column: "+o+" :: "+result.message+"<br>")}).always(function(){o=n.shift();var t=100;window.setTimeout(h,t)})}else{var a=100;$("#pb-current").css("width",a+"%"),$("#pb-current").html(a+"%"),window.setTimeout(g,250)}},v=function(){$("#pb").css("width","100%"),$("#pb").html("100%"),j(),_(lang_success),window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"utfcomplete"}}).done(function(t){var a=$.parseJSON(t.js);0!=a.errorCode&&(m=m+"<br>"+lang_sc_error),UIkit.modal.alert(lang_success);var e=$("#dbadmin_messages");""==m&&(m=lang_no_errors),e.html(m),$("#dbadmin_message_window").show(),$("#cvtb").html(lang_convert)})},3e3)},_=function(t){f.html(t)},T=function(){$t.show()},j=function(){$t.hide()};return t}();$(function(){dbadminint.init()});