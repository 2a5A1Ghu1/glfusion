/**
 * glFusion DB Admin - Ajax UTF8 Conversion
 *
 * Converts the database, tables, and columns in each table to the
 * utf8mb4_unicode_ci character set / collation.
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2016 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},n=null,e=null,a=null,o=null,r=0,i=1,l=null,d=0,s=0,c="",u=null;$t=null,t.update=function(){return d=0,l=$("#dbcvtform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#cvtb").prop("disabled",!0),$("#cvtb").html(lang_converting),v(),h(lang_retrieve_tables),$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"gettables"},timeout:3e4}).done(function(t){var a=$.parseJSON(t.js);0!=a.errorCode&&(alert(lang_error_gettable),window.location.href=destination),n=a.tablelist,s=n.length,e=n.shift(),window.setTimeout(m,1e3)}).fail(function(){alert(lang_error_gettable),window.location.href=destination}),!1},t.init=function(){"EdCICTd8idbqXnyfQ02FsQqD"==gl&&(u=$("#batchinterface_msg"),$t=$("#t"),u&&$("#cvtb").click(t.update))};var m=function(){h(lang_converting+" database");var t={mode:"utfdb"};data=$.param(t),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(alert(lang_error_db+" :: "+n.message),window.location.href=destination),window.setTimeout(b,1e3)}).fail(function(t,n){"timeout"===n?(alert(lang_error_db),window.location.href=destination):(alert(lang_error_db),window.location.href=destination)})},b=function(){if(e){var t={mode:"utftb",table:e};data=$.param(t),h(lang_converting+" "+d+"/"+s+" - "+e),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"Table: "+e+" :: "+n.message+"<br>");var a=Math.round(d/s*100);$("#pb").css("width",a+"%"),$("#pb").html(a+"%"),d++}).fail(function(t,n){"timeout"===n&&(alert(lang_error_table+" :: "+e),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(f,t)})}else p()},f=function(){if(e){a=null;var t={mode:"getcolumns",table:e};data=$.param(t),i=1;var n=0;$("#pb-current").css("width",n+"%"),$("#pb-current").html(n+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"Table: "+e+" :: "+n.message+"<br>"),a=n.columnlist,r=a.length,o=a.shift()}).fail(function(t,n){c=c+"Table: "+e+" :: Failed to retrieve column list<br>","timeout"===n&&(alert(lang_error_getcolumn+" :: "+e),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(g,t)})}},g=function(){if(o){var t={mode:"utfcm",table:e,column:o};data=$.param(t),h(lang_converting+" "+d+"/"+s+" - "+e+" - "+o);var u=Math.round(i/r*100);$("#pb-current").css("width",u+"%"),$("#pb-current").html(u+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"Table: "+e+" Column: "+o+" :: "+n.message+"<br>"),i++}).fail(function(t,n){"timeout"===n&&(c=c+"Table: "+e+" Column: "+o+" :: "+result.message+"<br>")}).always(function(){o=a.shift();var t=1e3;window.setTimeout(g,t)})}else{var u=100;$("#pb-current").css("width",u+"%"),$("#pb-current").html(u+"%"),e=n.shift(),window.setTimeout(b,1e3)}},p=function(){$("#pb").css("width","100%"),$("#pb").html("100%"),w(),h(lang_success),window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"utfcomplete"}}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"<br>"+lang_sc_error),UIkit.modal.alert(lang_success);var e=$("#dbadmin_messages");""==c&&(c=lang_no_errors),e.html(c),$("#dbadmin_message_window").show(),$("#cvtb").html(lang_convert)})},3e3)},h=function(t){u.html(t)},v=function(){$t.show()},w=function(){$t.hide()};return t}();$(function(){dbadminint.init()});