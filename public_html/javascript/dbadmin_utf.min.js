/**
 * glFusion DB Admin - Ajax UTF8 Conversion
 *
 * Converts the database, tables, and columns in each table to the
 * utf8mb4_unicode_ci character set / collation.
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2016 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},e=null,a=null,n=null,o=null,r=0,i=1,l=null,s=0,d=0,u="",c=null;$t=null,t.update=function(){return s=0,l=$("#dbcvtform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#cvtb").prop("disabled",!0),$("#cvtb").html(lang_converting),v(),w(lang_retrieve_tables),$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"gettables"},timeout:3e4}).done(function(t){var n=$.parseJSON(t.json);0!=n.errorCode&&(alert(lang_error_gettable),window.location.href=destination),e=n.tablelist,d=e.length,a=e.shift(),window.setTimeout(m,1e3)}).fail(function(){alert(lang_error_gettable),window.location.href=destination}),!1},t.init=function(){"EdCICTd8idbqXnyfQ02FsQqD"==gl&&(c=$("#batchinterface_msg"),$t=$("#t"),c&&$("#cvtb").click(t.update))};var m=function(){w(lang_converting+" database");var t={mode:"utfdb"};data=$.param(t),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var e=$.parseJSON(t.json);0!=e.errorCode&&(alert(lang_error_db+" :: "+e.message),window.location.href=destination),window.setTimeout(f,1e3)}).fail(function(t,e){"timeout"===e?(alert(lang_error_db),window.location.href=destination):(alert(lang_error_db),window.location.href=destination)})},f=function(){if(a){var t={mode:"utftb",table:a};data=$.param(t),w(lang_converting+" "+s+"/"+d+" - "+a),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var e=$.parseJSON(t.json);0!=e.errorCode&&(u=u+"Table: "+a+" :: "+e.message+"<br>");var n=Math.round(s/d*100);$("#pb").css("width",n+"%"),$("#pb").html(n+"%"),s++}).fail(function(t,e){"timeout"===e&&(alert(lang_error_table+" :: "+a),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(g,t)})}else p()},g=function(){if(a){n=null;var t={mode:"getcolumns",table:a};data=$.param(t),i=1;var e=0;$("#pb-current").css("width",e+"%"),$("#pb-current").html(e+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var e=$.parseJSON(t.json);0!=e.errorCode&&(u=u+"Table: "+a+" :: "+e.message+"<br>"),n=e.columnlist,r=n.length,o=n.shift()}).fail(function(t,e){u=u+"Table: "+a+" :: Failed to retrieve column list<br>","timeout"===e&&(alert(lang_error_getcolumn+" :: "+a),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(b,t)})}},b=function(){if(o){var t={mode:"utfcm",table:a,column:o};data=$.param(t),w(lang_converting+" "+s+"/"+d+" - "+a+" - "+o);var c=Math.round(i/r*100);$("#pb-current").css("width",c+"%"),$("#pb-current").html(c+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var e=$.parseJSON(t.json);0!=e.errorCode&&(u=u+"Table: "+a+" Column: "+o+" :: "+e.message+"<br>"),i++}).fail(function(t,e){"timeout"===e&&(u=u+"Table: "+a+" Column: "+o+" :: "+result.message+"<br>")}).always(function(){o=n.shift();var t=1e3;window.setTimeout(b,t)})}else{var c=100;$("#pb-current").css("width",c+"%"),$("#pb-current").html(c+"%"),a=e.shift(),window.setTimeout(f,1e3)}},p=function(){$("#pb").css("width","100%"),$("#pb").html("100%"),h(),w(lang_success),window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"utfcomplete"}}).done(function(t){var e=$.parseJSON(t.json);0!=e.errorCode&&(u=u+"<br>"+lang_sc_error),UIkit.modal.alert(lang_success);var a=$("#dbadmin_messages");""==u&&(u=lang_no_errors),a.html(u),$("#dbadmin_message_window").show(),$("#cvtb").html(lang_convert)})},3e3)},w=function(t){c.html(t)},v=function(){$t.show()},h=function(){$t.hide()};return t}();$(function(){dbadminint.init()});