/**
 * glFusion DB Admin - Ajax UTF8 Conversion
 *
 * Converts the database, tables, and columns in each table to the
 * utf8mb4_unicode_ci character set / collation.
 *
 * LICENSE: This program is free software; you can redistribute it
 *  and/or modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * @category   glFusion CMS
 * @package    dbAdmin
 * @author     Mark R. Evans  mark AT glFusion DOT org
 * @copyright  2015-2016 - Mark R. Evans
 * @license    http://opensource.org/licenses/gpl-2.0.php - GNU Public License v2 or later
 * @since      File available since Release 1.6.3
 *
 */
var dbadminint=function(){var t={},n=null,a=null,e=null,o=null,r=0,i=1,l=null,d=0,u=0,c="",s=null;$t=null,t.update=function(){return d=0,l=$("#dbcvtform").attr("action"),$("#dbadmin_batchprocesor").show(),$("#cvtb").prop("disabled",!0),$("#cvtb").html(lang_converting),w(),h(lang_retrieve_tables),$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"gettables"},timeout:3e4}).done(function(t){var e=$.parseJSON(t.js);0!=e.errorCode&&(alert(lang_error_gettable),window.location.href=destination),n=e.tablelist,u=n.length,a=n.shift(),window.setTimeout(b,1e3)}).fail(function(){alert(lang_error_gettable),window.location.href=destination}),!1},t.init=function(){"log"==gl&&(s=$("#batchinterface_msg"),$t=$("#t"),s&&$("#cvtb").click(t.update))};var b=function(){h(lang_converting+" database");var t={mode:"utfdb"};data=$.param(t),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(alert(lang_error_db+" :: "+n.message),window.location.href=destination),window.setTimeout(p,1e3)}).fail(function(t,n){"timeout"===n?(alert(lang_error_db),window.location.href=destination):(alert(lang_error_db),window.location.href=destination)})},p=function(){if(a){var t={mode:"utftb",table:a};data=$.param(t),h(lang_converting+" "+d+"/"+u+" - "+a),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"Table: "+a+" :: "+n.message+"<br>");var e=Math.round(d/u*100);$("#pb").css("width",e+"%"),$("#pb").html(e+"%"),d++}).fail(function(t,n){"timeout"===n&&(alert(lang_error_table+" :: "+a),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(m,t)})}else g()},m=function(){if(a){e=null;var t={mode:"getcolumns",table:a};data=$.param(t),i=1;var n=0;$("#pb-current").css("width",n+"%"),$("#pb-current").html(n+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"Table: "+a+" :: "+n.message+"<br>"),e=n.columnlist,r=e.length,o=e.shift()}).fail(function(t,n){c=c+"Table: "+a+" :: Failed to retrieve column list<br>","timeout"===n&&(alert(lang_error_getcolumn+" :: "+a),window.location.href=destination)}).always(function(){var t=250;window.setTimeout(f,t)})}},f=function(){if(o){var t={mode:"utfcm",table:a,column:o};data=$.param(t),h(lang_converting+" "+d+"/"+u+" - "+a+" - "+o);var s=Math.round(i/r*100);$("#pb-current").css("width",s+"%"),$("#pb-current").html(s+"%"),$.ajax({type:"POST",dataType:"json",url:l,data:data,timeout:6e4}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"Table: "+a+" Column: "+o+" :: "+n.message+"<br>"),i++}).fail(function(t,n){"timeout"===n&&(c=c+"Table: "+a+" Column: "+o+" :: "+result.message+"<br>")}).always(function(){o=e.shift();var t=1e3;window.setTimeout(f,t)})}else{var s=100;$("#pb-current").css("width",s+"%"),$("#pb-current").html(s+"%"),a=n.shift(),window.setTimeout(p,1e3)}},g=function(){$("#pb").css("width","100%"),$("#pb").html("100%"),v(),h(lang_success),window.setTimeout(function(){$.ajax({type:"POST",dataType:"json",url:l,data:{mode:"utfcomplete"}}).done(function(t){var n=$.parseJSON(t.js);0!=n.errorCode&&(c=c+"<br>"+lang_sc_error),UIkit.modal.alert(lang_success);var a=$("#dbadmin_messages");""==c&&(c=lang_no_errors),a.html(c),$("#dbadmin_message_window").show(),$("#cvtb").html(lang_convert)})},3e3)},h=function(t){s.html(t)},w=function(){$t.show()},v=function(){$t.hide()};return t}();$(function(){dbadminint.init()});